name: AI Advisor Evals

on:
  schedule:
    # Nightly at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      model:
        description: 'Model to evaluate'
        required: false
        default: 'claude-haiku-4-5-20251001'
        type: choice
        options:
          - claude-haiku-4-5-20251001
          - claude-sonnet-4-5-20250929

concurrency:
  group: evals-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  eval:
    name: Run Evals
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - run: npm ci

      - name: Run promptfoo evals
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: npx promptfoo eval -c evals/promptfooconfig.yaml --no-progress-bar

      - name: Collect results
        run: npx tsx evals/scripts/collect-results.ts

      - name: Upload eval results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eval-results-${{ github.run_id }}
          path: evals/results/
          retention-days: 90

      - name: Check regression evals
        run: |
          # Parse latest results and fail if any regression test failed
          node -e "
            const fs = require('fs');
            const index = JSON.parse(fs.readFileSync('evals/results/results-index.json', 'utf-8'));
            if (!index.length) { console.log('No results to check'); process.exit(0); }
            const latest = JSON.parse(fs.readFileSync('evals/results/' + index[index.length - 1], 'utf-8'));
            const regressionCases = latest.testCases.filter(tc => tc.testType === 'regression');
            const failures = regressionCases.filter(tc => !tc.passed);
            console.log('Regression results: ' + (regressionCases.length - failures.length) + '/' + regressionCases.length + ' passed');
            if (failures.length > 0) {
              console.error('REGRESSION FAILURES:');
              failures.forEach(f => console.error('  - ' + f.message + ' (score: ' + f.score + ')'));
              process.exit(1);
            }
            console.log('All regression evals passed.');
          "
